#!/bin/sh

LF='
'
if test $# -lt 1
then
	DIR='..'
else
	DIR=$1
fi

SVF=SHAPES-VERSION-FILE
SVF_DEF=$DIR/VERSION
SVF_DIST=version
VN=$(sed -e '2,$ d' < $SVF_DEF)
VD=$(date -R)

if test -f $SVF_DIST
then
	VN=$(sed -e '/NUMBER/! d' -e 's/VERSION_NUMBER := //' < $SVF_DIST)
	VD=$(sed -e '/DATE/! d' -e 's/VERSION_DATE := //' < $SVF_DIST)
elif test -d $DIR/.git &&
	VN=$(cd $DIR && git describe --abbrev=4 HEAD 2>/dev/null) &&
	case "$VN" in
	*$LF*) (exit 1) ;;
	[0-9]*) : ;;
	esac
then
	if test -z "$(git diff-index --name-only HEAD)"
	then
		VD=$(git show --quiet --pretty="format:%cD" HEAD)
	else
		VN="$VN-dirty"
	fi
fi

if test -r $SVF
then
	FVN=$(sed -e '/NUMBER/! d' -e 's/VERSION_NUMBER := //' < $SVF)
	FVD=$(sed -e '/DATE/! d' -e 's/VERSION_DATE := //' < $SVF)
else
	FVN=undef
	FVD=undef
fi

test "$VD" = "$FVD" -a "$VN" = "$FVN" || {
	echo >&2 "\
VERSION_NUMBER := ${VN}
VERSION_DATE := ${VD}"
	echo "\
VERSION_NUMBER := ${VN}
VERSION_DATE := ${VD}" > $SVF
}
